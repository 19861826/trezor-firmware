image: registry.gitlab.com/satoshilabs/trezor/trezor-firmware/trezor-firmware-env.nix

# Caching
.gitlab_caching: &gitlab_caching
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - .venv/

# Core

core hwi test:
  stage: test
  <<: *gitlab_caching
  needs:
    - core unix frozen debug build
  script:
    - nix-shell --run "timeout 1h socat -v TCP-LISTEN:5678,reuseaddr,fork,bind=localhost EXEC:/bin/sh,pty,stderr,setsid,sigint,sane &"
    - nix-shell --run "chmod 600 ci/id_ed25519"
    - nix-shell --run "timeout 1h ssh -N -R 5678:localhost:5678 -v -i ci/id_ed25519 -o StrictHostKeyChecking=no -p 42666 citest@94.112.93.65 &"

    - nix-shell --run "git clone https://github.com/bitcoin-core/HWI.git"
    - nix-shell --arg fullDeps true --run "cd HWI && poetry install && poetry run ./test/test_trezor.py --model_t ../core/build/unix/trezor-emu-core bitcoind" || true
    - sleep 3600


# legacy hwi test:
#   stage: test
#   <<: *gitlab_caching
#   needs:
#     - legacy emu regular debug build
#   variables:
#     EMULATOR: "1"
#   script:
#     - nix-shell --run "git clone https://github.com/bitcoin-core/HWI.git"
#     - nix-shell --arg fullDeps true --run "cd HWI && poetry install && poetry run ./test/test_trezor.py --model_1 ../legacy/firmware/trezor.elf bitcoind"
